@page "/bilder"

@using VogelWedding.Services
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@using System.IO
@using VogelWedding.Interfaces
@using VogelWedding.Modals

@inject ISupabasePhotosService SupabasePhotosService
@inject AccessService AccessService
@inject ISnackbar Snackbar
@inject IBlazorCurrentDeviceService CurrentDevice

<div class="page-wrapper">
    <Background/>

    <!-- Upload Section -->
    <div class="card page-container">
        <div class="@(IsMobile ? "page-card-frosted text-center" : "card-body page-card-frosted text-center")">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title mb-4">Fotos</h1>

                    <div class="mb-3">
                        <p>Lade hier deine Schnappsch체sse hoch!</p>
                        <!-- Custom styled file upload -->
                        <div class="d-grid gap-2 col-md-6 mx-auto">
                            <label class="btn btn-primary btn-lg">
                                <span class="bi bi-cloud-upload-fill me-2"></span>
                                Fotos ausw채hlen
                                <!-- InputFile is hidden but triggered by the label -->
                                <InputFile OnChange="OnFilesSelected" multiple hidden accept="image/*"/>
                            </label>
                        </div>
                    </div>

                    @if (_isUploading)
                    {
                        <div class="progress mt-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-animated progress-bar-primary"
                                 role="progressbar"
                                 style="width: @(CalculateProgress())%">
                                @* Uploading... @(_uploadedCount) / @(_totalToUpload) *@
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card page-container mt-2">
        <div class="@(IsMobile ? "page-card-frosted" : "card-body page-card-frosted")">
            <div class="card">
                <div class="card-body">
                    <!-- Gallery Section -->
                    @if (_isLoadingImages)
                    {
                        <div class="d-flex justify-content-center my-5">
                            <div class="spinner-border text-light" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (_imageUrls.Any())
                    {
                        <div class="row g-3">
                            @foreach (var url in _imageUrls)
                            {
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="card h-100 shadow-sm border-0" @onclick="() => OpenFullscreen(url)" style="cursor: pointer;">
                                        <div class="ratio ratio-1x1">
                                            <img src="@url" class="card-img-top object-fit-cover rounded"
                                                 alt="Wedding photo"
                                                 style="width:100%; height:100%;" loading="lazy"/>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-secondary text-center mt-4" role="alert">
                            Noch keine Fotos vorhanden.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal (Bootstrap) -->
@if (_showPreviewModal)
{
    <PhotoUploadPreviewModal FilesToUpload="_filesToUpload"
                             PreviewUrls="_previewUrls"
                             IsLoading="_isPreviewLoading"
                             IsUploading="_isUploading"
                             OnClose="ClosePreviewModal"
                             OnConfirm="ConfirmUpload"
                             OnRemoveFile="RemoveFileFromSelection"/>
}

<!-- Fullscreen Modal for Image -->
@if (_showFullscreenModal)
{
    <PhotoFullscreenModal ImageUrl="@_selectedFullsizeUrl"
                          OnClose="CloseFullscreen"/>
}

@code {
    private bool IsMobile { get; set; }

    private const string CeremonyFolder = "/Ceremony";
    private const string PartyFolder = "/Party";

    private bool _isUploading = false;
    private bool _isLoadingImages = true;
    private string _selectedUploadFolder = CeremonyFolder;
    private List<string> _imageUrls = new();

    // Modal & Upload State
    private bool _showPreviewModal = false;
    private bool _isPreviewLoading = false;
    private IReadOnlyList<IBrowserFile> _selectedFiles;
    private List<IBrowserFile> _filesToUpload = new();
    private List<string> _previewUrls = new();
    private int _uploadedCount = 0;
    private int _totalToUpload = 0;
    
    // Fullscreen state of Image modal
    private bool _showFullscreenModal = false;
    private string _selectedFullsizeUrl = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            IsMobile = await CurrentDevice.Mobile();
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // if (AccessService.CurrentLevel >= AccessLevel.GuestInvited)
        if (AccessService.CurrentLevel >= AccessLevel.TestUserInvited)
        {
            _selectedUploadFolder = PartyFolder;
        }
        else
        {
            _selectedUploadFolder = CeremonyFolder;
        }

        await LoadImages();
    }

    private async Task LoadImages()
    {
        _isLoadingImages = true;
        _imageUrls.Clear();

        try
        {
            var level = AccessService.CurrentLevel;

            // TODO: Change User Access Level to guests
            // if (level >= AccessLevel.GuestAll)
            // {
            //     var ceremonyPhotos = await SupabasePhotosService.GetImageUrlsAsync(CeremonyFolder);
            //     _imageUrls.AddRange(ceremonyPhotos);
            // }
            //
            // if (level >= AccessLevel.GuestInvited)
            // {
            //     var partyPhotos = await SupabasePhotosService.GetImageUrlsAsync(PartyFolder);
            //     _imageUrls.AddRange(partyPhotos);
            // }

            if (level >= AccessLevel.TestUserAll)
            {
                var ceremonyPhotos = await SupabasePhotosService.GetImageUrlsAsync(CeremonyFolder);
                _imageUrls.AddRange(ceremonyPhotos);
            }

            if (level >= AccessLevel.TestUserInvited)
            {
                var partyPhotos = await SupabasePhotosService.GetImageUrlsAsync(PartyFolder);
                _imageUrls.AddRange(partyPhotos);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingImages = false;
        }
    }

    // Triggered when files are selected from the InputFile component
    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        // GetMultipleFiles(maxCount) ensures we can handle more than default 10
        try
        {
            _selectedFiles = e.GetMultipleFiles(100);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Zu viele Dateien ausgew채hlt: {ex.Message}", Severity.Warning);
            return;
        }

        if (_selectedFiles == null || !_selectedFiles.Any()) return;

        _showPreviewModal = true;
        _previewUrls.Clear();
        _filesToUpload.Clear();
        _isPreviewLoading = true;
        StateHasChanged();

        // Generate previews for all selected files
        var filesToPreview = _selectedFiles.ToList();
        long maxFileSize = 1024 * 1024 * 20; // 20MB limit for preview reading

        foreach (var file in filesToPreview)
        {
            try
            {
                if (file.ContentType.StartsWith("image/"))
                {
                    // Create 300x300 thumbnail
                    var resizedFile = await file.RequestImageFileAsync("image/jpeg", 300, 300);
                    var buffer = new byte[resizedFile.Size];
                    await resizedFile.OpenReadStream(maxFileSize).ReadAsync(buffer);
                    var base64 = Convert.ToBase64String(buffer);
                    _previewUrls.Add($"data:image/jpeg;base64,{base64}");
                    _filesToUpload.Add(file);
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Preview failed: {ex.Message}");
            }
        }

        _isPreviewLoading = false;
    }

    private void RemoveFileFromSelection(int index)
    {
        if (index >= 0 && index < _filesToUpload.Count)
        {
            _filesToUpload.RemoveAt(index);
            _previewUrls.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void ClosePreviewModal()
    {
        _showPreviewModal = false;
        _selectedFiles = null;
        _filesToUpload.Clear();
        _previewUrls.Clear();
    }

    private async Task ConfirmUpload()
    {
        if (_filesToUpload == null || !_filesToUpload.Any()) return;

        _showPreviewModal = false; // Close modal
        _isUploading = true;
        _totalToUpload = _filesToUpload.Count;
        _uploadedCount = 0;
        StateHasChanged();

        try
        {
            var results = await SupabasePhotosService.UploadFilesAsync(_filesToUpload, _selectedUploadFolder, count =>
            {
                _uploadedCount = count;
                StateHasChanged();
            });

            if (results.Any())
            {
                Snackbar.Add($"{results.Count} Bilder erfolgreich hochgeladen!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Keine Bilder hochgeladen. Siehe Konsole f체r Details.", Severity.Warning);
            }

            await LoadImages();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload fehlgeschlagen: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUploading = false;
            _selectedFiles = null;
            _filesToUpload.Clear();
        }
    }

    private double CalculateProgress()
    {
        if (_totalToUpload == 0) return 0;
        return (double)_uploadedCount / _totalToUpload * 100;
    }

    private void OpenFullscreen(string url)
    {
        _selectedFullsizeUrl = url;
        _showFullscreenModal = true;
    }

    private void CloseFullscreen()
    {
        _showFullscreenModal = false;
        _selectedFullsizeUrl = "";
    }
}